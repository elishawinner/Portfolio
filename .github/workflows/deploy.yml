name: 🚀 cPanel Deployment

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: 🔍 Checkout Code
      uses: actions/checkout@v4

    - name: 🔐 SSH Key Setup
      run: |
        mkdir -p ~/.ssh
        # Decode base64 encoded key
        echo "${{ secrets.CPANEL_SSH_KEY }}" | base64 -d > ~/.ssh/cpanel_deploy
        chmod 600 ~/.ssh/cpanel_deploy
        
        # Validate key structure
        echo "Key header: $(head -1 ~/.ssh/cpanel_deploy)"
        echo "Key footer: $(tail -1 ~/.ssh/cpanel_deploy)"
        
        if ! ssh-keygen -l -f ~/.ssh/cpanel_deploy; then
          echo "::error::Invalid key format - regenerate with 'ssh-keygen -t rsa -m PEM'"
          exit 1
        fi

    - name: 🚀 Deployment
      uses: easingthemes/ssh-deploy@v4.0.0
      with:
        SSH_PRIVATE_KEY: ${{ secrets.CPANEL_SSH_KEY }}
        REMOTE_HOST: ${{ secrets.CPANEL_HOST }}
        REMOTE_USER: ${{ secrets.CPANEL_USER }}
        REMOTE_PORT: ${{ secrets.CPANEL_PORT || '22' }}
        SOURCE: 'build/'
        TARGET: ${{ secrets.CPANEL_DEPLOY_PATH }}
        ARGS: '-rlgoDzvc --delete'
        SSH_CMD_ARGS: '-o IdentitiesOnly=yes -i ~/.ssh/cpanel_deploy'